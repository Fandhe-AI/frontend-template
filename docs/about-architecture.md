# アーキテクチャについて

## 概要

このプロジェクトは **モジュラーモノリス** アーキテクチャを採用し、[Feature-Sliced Design](https://feature-sliced.design/) の設計原則に基づいて構築されています。

現在は基本的なモノレポ構成から始まり、段階的に完全なFeature-Sliced Designアーキテクチャに移行していく計画です。

## モノレポ構成

このプロジェクトは **Turborepo** を使用したモノレポ構成を採用しています。

### パッケージマネージャー
- **pnpm** (v9.0.0以上) を使用
- ワークスペース機能により、効率的な依存関係管理を実現
- `workspace:*` プロトコルによる内部パッケージ参照

### ビルドシステム
- **Turbo** (v2.5.4以上) によるタスクオーケストレーション
- 並列実行とインクリメンタルビルドによる高速化
- キャッシュ機能により、不要な再ビルドを削減
- TUI（Terminal User Interface）による視覚的なタスク実行状況の表示

## アーキテクチャパターン

### Feature-Sliced Design (FSD)

このプロジェクトは [Feature-Sliced Design](https://feature-sliced.design/) アーキテクチャを採用しています。

#### レイヤー構成

```
┌────────────────────┐
│      app           │ ← アプリケーション全体の設定・初期化
├────────────────────┤
│      pages         │ ← ページレベルのコンポーネント
├────────────────────┤
│      widgets       │ ← 独立したUIブロック
├────────────────────┤
│      features      │ ← ビジネス価値のある機能
├────────────────────┤
│      entities      │ ← ビジネスエンティティ
├────────────────────┤
│      shared        │ ← 再利用可能なリソース
└────────────────────┘
```

#### レイヤー詳細

- **app**: アプリケーション全体の初期化、設定、ルーティング
  - 現在: `apps/` ディレクトリで実装済み
  - Next.jsアプリケーション、ドキュメントサイトなど

- **pages**: 特定のページに対応するコンポーネント
  - 計画: `packages/pages/` で実装予定
  - ルーティング、レイアウト、ページ固有のロジック

- **widgets**: ページ間で再利用可能な独立したUIブロック
  - 計画: `packages/widgets/` で実装予定
  - ヘッダー、サイドバー、フッターなどの大きなUIブロック

- **features**: ユーザーの行動やビジネス価値を提供する機能
  - 計画: `packages/features/` で実装予定
  - 認証、検索、フィルタリングなどの機能単位

- **entities**: ビジネスドメインのエンティティ（ユーザー、商品など）
  - 計画: `packages/entities/` で実装予定
  - データモデル、ビジネスルール、API呼び出し

- **shared**: 汎用的なUI、ユーティリティ、設定など
  - 現在: `packages/ui/`, `packages/typescript-config/` で部分実装
  - 将来: API関連、設定、ユーティリティなどを追加予定

### 依存関係ルール

```
app → pages → widgets → features → entities → shared
```

- **上位レイヤーは下位レイヤーに依存可能**
- **下位レイヤーは上位レイヤーに依存不可**
- **同一レイヤー内での依存は原則禁止**

このルールにより、循環依存を防ぎ、コードの保守性と再利用性を確保します。

## 技術スタック

### フロントエンド

- **React** (v19.1.0) - UIライブラリ
- **Next.js** (v15.3.0) - フルスタックReactフレームワーク
  - App Router使用
  - Turbopackによる高速開発
- **TypeScript** (v5.8.2) - 型安全性の確保

### 開発ツール

- **ESLint** - コード品質の維持
- **Prettier** - コードフォーマット
- **Turbo** - モノレポビルドシステム

### 将来導入予定

- **Biome** - 統合的なコード品質管理
- **Vitest** - 高速テストランナー
- **Playwright** - E2Eテスト
- **Storybook** - UIコンポーネント開発環境
- **Kubb** - OpenAPI自動生成ツール

### UI・スタイリング

- コンポーネントライブラリは `packages/ui` で管理
- 将来的にはTailwind CSSの導入も検討
- デザインシステムの統一化

## 現在のワークスペース構成

### apps/ (app層)
- **docs/**: TypeDocなどによるドキュメント生成
- **web/**: Next.jsを使用したメインWebアプリケーション

### packages/ (shared層 + 設定)
- **typescript-config/**: TypeScript設定の共有  
- **ui/**: 共通UIコンポーネント

## 移行ロードマップ

### フェーズ1: 基盤整備（完了）
- ✅ 基本的なモノレポ構成
- ✅ Turborepo + pnpm設定
- ✅ 共通設定パッケージ
- ✅ 基本UIコンポーネント

### フェーズ2: 開発環境の充実（次期実装予定）
- Dependency cruiser、Biome、Storybook、Vitest、Playwright導入

### フェーズ3: Feature-Sliced Design完全導入
- pages、widgets、features、entities各層の実装

### フェーズ4: API・データ管理
- OpenAPI仕様、Kubb、モックサーバー、状態管理の導入

### フェーズ5: 品質・運用強化
- CI/CD、Git hooks、依存関係管理の自動化

詳細な実装計画は [TODO リスト](./todo.md) を参照してください。

## 開発プロセス

開発環境のセットアップ、コーディング規約、コミット規約、テスト戦略などの詳細は [開発ガイドライン](./development-guide.md) を参照してください。

## 設計原則

### 1. 単一責任の原則 (SRP)
- 各レイヤー、各パッケージは明確な責任を持つ
- 関心事の分離を徹底
- 機能の変更が他の部分に影響しないよう設計

### 2. 依存性の逆転 (DIP)
- 上位レイヤーが下位レイヤーに依存
- インターフェースを通じた疎結合
- テスタビリティの向上

### 3. 開放閉鎖の原則 (OCP)
- 拡張に対して開放、修正に対して閉鎖
- 新機能追加時の既存コードへの影響を最小化

### 4. 型安全性
- TypeScriptによる静的型検査
- 実行時エラーの最小化
- API通信における型安全性の確保

### 5. 再利用性
- 共通コンポーネントとユーティリティの分離
- ワークスペース間での効率的な依存関係管理
- DRY原則の徹底

## スケーラビリティ戦略

### 水平スケーリング
- **新機能追加**: 独立したパッケージとして実装
- **Feature-Sliced Design**: 機能の明確な分離
- **チーム分担**: レイヤー・機能単位での開発

### 垂直スケーリング  
- **レイヤー拡張**: 段階的な機能追加
- **依存関係管理**: ルールの維持と最適化
- **パフォーマンス**: バンドルサイズの最適化

### チーム開発
- **パッケージ単位**: 明確な責任範囲
- **レイヤー境界**: 責任分離による並行開発
- **API契約**: インターフェースによる疎結合

## パフォーマンス最適化

### 現在の取り組み
- **Turboキャッシュ**: ビルド時間の短縮
- **Code Splitting**: Next.jsによる自動最適化
- **TypeScript**: コンパイル時最適化

### 将来の計画
- **Bundle分析**: webpack-bundle-analyzerの導入
- **Tree Shaking**: 不要コードの除去
- **懒読み込み**: React.lazyによる動的インポート
- **画像最適化**: Next.js Image最適化の活用

## セキュリティ

### 現在の対策
- **依存関係**: pnpm auditによる脆弱性チェック
- **TypeScript**: 型安全性による実行時エラー防止

### 将来の強化
- **CSP**: Content Security Policyの実装
- **HTTPS**: 本番環境での強制
- **認証**: セキュアな認証システムの実装
- **監査**: 定期的なセキュリティ監査の実施

## 監視・運用

### 開発環境監視
- **Turbo**: タスク実行状況の可視化
- **TypeScript**: 型エラーの即座検出
- **ESLint**: コード品質の継続監視

### 将来の運用改善
- **エラー監視**: Sentryなどの導入
- **パフォーマンス**: Web Vitalsの監視
- **ログ**: 構造化ログの実装
- **アラート**: 異常検知システムの構築
